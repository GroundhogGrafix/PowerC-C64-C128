KKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKR A         LDX #$FF                      <== -1         LDY NEWVALUE         RTSNOMOV    LDA #0         RTS;;;MOUSEOFF SEI ;       TURN OFF  INTERRUPT DRIVEN MOUSE ROUTINE.         LDA IIRQ2         STA IIRQ         LDA IIRQ2+1        ;    K  K< =`   INKEY    C$FUNCTINIT       TO CONTINUE.", 13       .BYTE 0ZEROSAVE .BSS 8 0DECML1 .BYTE 0DECML2 .BYTE 0,0DECML3 .BYTE 0NUMFIL .BYTE 0,0 ;NUMBER OF FILES TO SENDDEVNUM .BYTE 8INDRIVE .BYTE "0"FRGCOLOR .BYTE 0CAN   rB    KA  @   @ K  A   @ `      + 6  GETKEY    C$FUNCTINIT       ML1 .BYTE 0DECML2 .BYTE 0,0DECML3 .BYTE 0NUMFIL .BYTE 0,0 ;NUMBER OF FILES TO SENDDEVNUM .BYTE 8INDRIVE .BYTE "0"FRGCOLOR .BYTE 0CAN  KKKKKKKKK *  STA IIRQ+1         CLI         RTS;       ELSE...         RTSHICH     ORA #%11000000 ; ELSE   OR IN HIGH ORDER BITS         CMP #$FF ;              IF <>$3F (VALUE <> -1)         BEQ NOMOV         SEC                          /2         ROKKKKKKKK; CHAR INKEY();; ETS A KEY FROM THE KEYBOARD WITHOUT ; WAITING. . INKEY . C$FUNCTINITC$PARMS = $033CLRCHN  = $GETIN   = $4INKEY  JSR C$FUNCTINIT  STX $4B  JSR CLRCHN  JSR GETIN  LDX $4B  STA C$PARMS,X  LDA #$00  STA ;----------------------------------;; CHAR GETKEY (WAIT, ECHO); CHAR WAIT, ECHO;;;----------------------------------;; ILENAME:   GETKEY.A; UTHOR:     RZYSZTOF DAMSKI; PDATED:    15-OV-1987;;----------------------------------;; ETS A ;;                        *** IRQMOUSE.A ***;;;   HIS IS ADAPTED FROM THE ROUTINE ON THE OMMODORE 1351 OUSE TILITY ISK,;BY OWARD IBSON, TO BE COMPILED WITH . HIS ROUTINE GETS THE X AND Y;CO-ORDINATES FROM THE MOUSE, AND STORES THEM IN  DELTA VALUES FOR X.         LDY OPOTX         JSR MOVCHK       CHECK FOR MOVEMENT.         STY OPOTX         CLC ;            MODIFY LOW ORDER X POSITION.         ADC XCRD         STA XCRD         TXA         ADC #$00         AND #%00000001   UNCTINITC$PARMS = $0400 ; FOR 128      $033C FOR 64   = $4  = $2GETKEY         JSR  C$FUNCTINIT         STX  $4         LDA  C$PARMS+2,X    ;GET SECOND PARM         STA  ECHO           ;PUT IT IN ECHO         LDA  C$PARMS,XMAT. O TURN OFF THIS ROUTINE, CALL MOUSEOFF(). HIS WILL SET;THE  VECTOR TO WHATEVER IT WAS PRIOR TO MOUSEON().;;;IIRQ     =  $0314 ;        EGISTERVIC      =  $D000 ;       TART OF  CHIPSID      =  $D400 ;       TART OF  CHIPPOTX  EOR #$FF         ADC YCRD         STA YCRD         JMP (IIRQ2)      CONTINUE WITH  OPERATION.;;;MOVCHK   STY OLDVALUE ;   SAVE OLD & NEW VALUES.         STA NEWVALUE         LDX #0 ;         PRELOAD X WITH ZERO.         SEC;              RD         BNE  END            ;IF GOT ONE EXIT LOOP         LDA  WAIT           ;CHECK IF WAIT FOR CHAR         BNE  LOOP           ; WAS REQUESTEDEND      LDX  $4         STA  C$PARMS,X      ;RETURN CHAR         LDA  #$00           ;CLEAR THE ING TO  ROUTINES.OPOTX    .BSS 1OPOTY    .BSS 1NEWVALUE .BSS 1OLDVALUE .BSS 1;;;         .DEF MOUSEON, MOUSEOFFMOUSEON  LDA IIRQ+1 ;     CHECK HI  VECTOR.         CMP #>MIRQ ;     ALREADY SET?         BEQ INSTEXT ;    IF ...         NO MOVEMENT.         LDY NEWVALUE ;          ELSE...         RTSHICH     ORA #%11000000 ; ELSE   OR IN HIGH ORDER BITS         CMP #$FF ;              IF <>$3F (VALUE <> -1)         BEQ NOMOV         SEC                          /2         RO  THEN         BEQ  FIN            ; DON'T BOTHER WITH CURSOR         LDA  #$           ;DISABLE THE         STA  $            ; BLINKING CURSORFIN      RTSWAIT     .BYTE 0             ;WAIT FLAGECHO     .BYTE 0             ;ECHO FLAGLEAR THE   VECTOR TO START OF POT-READ ROUTINE.         STA IIRQ         LDA #>MIRQ         STA IIRQ+1         PLPINSTEXT  RTS ;            HY HASN'T  INTERRUPT BEEN RESET?;;;MIRQ     CLD ;            JUST IN CASE...         LDA POTX ;       GET C$PARMS+1,X  RTS                                                                                                                                                                                                                                           KEY FROM THE KEYBOARD; WITH OR WITHOUT WAITING.; NABLES THE CURSOR BLINK.;;; IF WAIT IS 0 -> NO WAITING;            1 -> WAITS;; IF ECHO IS 0 -> NO OUTPUT;            1 -> KEY ECHOED;;---------------------------------- . GETKEY . C$FXCRD, AND YCRD, WHICH CAN BE;BE DEFINED AS EXTERN UNSIGNED INT TYPE OBJECTS IN OWER .;;   O USE IT, CALL MOUSEON() FROM . HE ROUTINE IS NOW PART OF THE ;INTERRUPT ROUTINE, AND XCRD AND YCRD WILL CONTAIN THE X, Y CO-ORDINATES IN;320 * 200 FOR      EOR XCRD+1         STA XCRD+1         LDA POTY ;       GET DELTA VALUE FOR Y.         LDY OPOTY         JSR MOVCHK ;     CHECK FOR MOVEMENT.         STY OPOTY         SEC ;            MODIFY Y POSITION (DECREASE Y FOR INCREASE IN POT)             ;GET FIRST PARM         STA  WAIT           ;PUT IT IN WAIT         BEQ  LOOP           ;DON'T TOUCH CURSOR         LDA  #$00           ;ENABLE THE         STA  $            ; BLINKING CURSORLOOP     JSR            ;GET CHAR FORM KEYBOA     =  SID+$19 ;      POTENTIOMETER INPUTPOTY     =  SID+$1A ;      POTENTIOMETER INPUT;;;;   O-ORDINATES TO BE ACCESSED BY OWER          .DEF XCRD, YCRDXCRD     .BSS 2YCRD     .BSS 2;;;IIRQ2    .BSS 2 ;         JUMP VECTOR FOR RETURN	<== MOD64 (NEW-OLD)         SBC OLDVALUE         AND #%01111111   CLEAR .         CMP #%01000000          BCS HICH         IF  => $40  (ACTUAL VALUE > 0)         LSR A ;                 /2         BEQ NOMOV ;             IF NOW ZERO, THERE IS
        STA  C$PARMS+1,X    ; HIGH BYTE         LDA  ECHO           ;CHECK IF ECHO         BEQ  RETURN         ; NOT SO RETURN         LDA  C$PARMS,X      ;GET THE CHAR         JSR           ; OUTPUT ITRETURN   LDA  WAIT           ;IF NO WAIT  PHP ;            STORE LO VECTOR ON STACK.  [???]         SEI ;            STOP THE  INTERRUPT.         LDA IIRQ ;       STORE 'OLD'  IN JUMP VECTOR.         STA IIRQ2         LDA IIRQ+1         STA IIRQ2+1         LDA #<MIRQ ;     RESETA                   CASSM64STUFFCS2A                                                                                       INKEY.A            GETKEY.A            IRQMOUSE.A             SCROLLDIR.A         K   INKEY.O            GETKEY.O                                                                          KKKKKKKKKKKKKKKKK;; ILENAME:  SCROLLDIR.A;; HIS PROGRAM IS A LINKABLE FUNCTION; TO  OR ASSEMBLER PROGRAMS.; HEN IT IS CALLED IT READES THE; DRIVE DIRECTORY (DEPENDING ON PATTERN); AND DISPLAYES IT ON THE SCREEN; IN A WAY THAT THE USER CAN SCROLL; UP AND DOWNDE:; IF DIRFLAG = 255 THEN NO FILES CAN; BE SELECTED, DEFAULT 0 .DEF DIRFLAG;-------------------------------------- .REF C$START .REF PRINTFC$PARMSIZE   = $00FBC$PARMS      = $033CSTACKPTR     = $001A;SCROUT = $E716 ; OUTPUT A CHAR TO SCR11 SEC RTSDIRL3 INX CPX #32 BNE DIRL2 JSR CLRCHN LDX #0 LDA DIRIN+1 CMP #1 ;NORMAL LINK? BEQ DIRL4 LDX #2 ;NO, FIRST LINE, SKIP FIRST TWO BYTESDIRL4 LDA DIRIN+4,X CMP #18 ;FIRST LINE? BNE DIRL6 LDY #5DIRL5 LDA DRVDAT,Y ;PUT "DRIVE" IN NMENT BY; RZYSZTOF DAMSKI ON 1-EC-1987;; RIGINAL ASSEMBLER CODE BY; ON OLTZ AND POSSIBLY LLAN EO; AND POSSIBLY BY MORE...;;--------------------------------------;; ;; INT SCROLLDIRECTORY (PATTERN, FUNCTION); CHAR *PATTERN; /*GETBYT = $FFA5UNTALK = $FFABC$$START JMP C$START;; COLLECT FILESDISTRN LDA CROUT+1 BNE OKFINE LDA CROUT+2 BNE OKFINE RTSOKFINE LDX TFNAM LDA #0 STA TFNAM+1,X LDX #<TFNAM+1 LDY #>TFNAM+1 STX C$PARMS STY C$PARMS+1 JSR SAVEZERO LD ENDDIR CLC RTSDIRL6 CMP #'B ;BLOCKS FREE? BNE DIRL8 LDA ENDDIR ;RETURN BLANK LINE BEFORE BLOCKS FREE ORA #2 STA ENDDIR CLC RTSDIRL16 LDY #13DIRL7 LDA BLKDAT,Y STA DIRBUF,Y DEY BPL DIRL7 INC ENDDIR LDY #13 BNE PUTNUM ;PUT NUMBER AFTER IS PASSED AS FUNCTION ADDRESS; NOTHING GETS CALLED AFTER DIRECTORY; IS DISPLAYED.;;--------------------------------------;;  (UN)SELECTS A FILE; / KEY ENDS THE DIRECTORY; = ABORTS DIRECTORY; 1 GOES TO TOP OF SCREEN THEN DIRECTOR*******;;;;SCREN  =$22 ; $02GEN    =$24 ; $04TXTPNT =$26 ; $06COLR   =$28 ; $0ADIRWID =28WIDTH  =40DIRCHN =9SETIN  =$FFC6MAXLNE =25TOPLIN =0SCN    =$0400; INDENTSCOL    =$D800; WATCH THIS SHIT TOO;DIRLNE LDX #DIRWID ;GET DIRECTORY LINE R JSR TOSCN STA DIRBUF,Y INY DEC TEMP BNE DIRL14 PLA TAXPUTNUM TYA PHA LDA DIRIN+3,X PHA LDA DIRIN+2,X TAX PLA LDY #$FF JSR DECOUT ;PUT NUMBER IN MEMORY STY START LDA #5 SEC SBC START STA START PLA;SEC ADC START TAY LDX #0PUTN; DEVICE NUMBER THAT CAN BE CHANGED; FROM , DEFAULT IS 8 .DEF DEVNUM; DRIVE NUMBER THAT CAN BE CHANGED; FROM , DEFAULT IS '0' .DEF INDRIVE; FORGROUND COLOR THAT CAN BE CHANGED; FROM , DEFAULT IS BLACK (0) .DEF FRGCOLOR; SELECT DIRECTORY MODIRL15 CLC RTSDIRL13 LDX #DIRCHN ;GET A STANDARD DIRECTORY LINE JSR SETIN LDX #0DIRL2 JSR CHRIN STA DIRIN,X LDY STATUS BEQ DIRL3 SEC ROR ENDDIR ;END OF DIRECTORY LDY STATUS CPY #64 ;END OF FILE? BEQ DIRL3 ;YES JSR CLRCHN ;REAL ERRORDIRL TO SELECT FILES.; HEN IT CALLES A FUNCTION (WHICH; ADDRESS HAS BEEN PASSED) WITH ONE FILE; AT A TIME, FROM THE LIST OF FILES; SELECTED BY THE USER.;;--------------------------------------;; SSEMBLER ROUTINE ADAPTED TO RUN; WITH  POWER ENVIROSTATUS = 144STKEY  = 145PNT    = 209MEMORY = $D000EMPTY  = $E000-MEMORYGETKEY = $F142CHRIN  = $FFCFCHROUT = $FFD2CLOSE  = $FFC3CLRCHN = $FFCCGETIN  = $FFE4OPEN   = $FFC0SETLFS = $FFBASETNAM = $FFBDTALK   = $FFB4CURDEV = $BATALKSA = $FF96BUFFER STA DIRBUF,Y DEY BPL DIRL5 LDA DIRIN+2,X ORA #'0 STA DIRBUF+6 ;SAVE DRIVE NUMBER LDA #': STA DIRBUF+7 LDA DIRIN+24,X ;SAVE ID JSR TOSCN STA DIRBUF+26 LDA DIRIN+25,X JSR TOSCN STA DIRBUF+27 LDY #8 JSR PUTNAM ;PUT NAME IN BUFFER INC '*' APPENDED AT THE END */; INT (*FUNCTION) ();;; THE (*FUNCTION) () IS DECLARED:;; INT FUNCTION (S); CHAR *S;;;  WHEN IT GETS CONTROL THE 'FUNCTION';  GETS THE POINTER TO A FILENAME FROM;  DIRECTORY, IN THE FORMAT:;  "0:FILENAME,S";; F A #$02CROUT JSR !$0000   ; <-  ROUTINE JSR RESETSTACK RTS;;;;******************************;*     EAGLETERM SCROLLING    *;*          DIRECTORY         *;*        BY DON HOLTZ        *;* 06/13/85                   *;*********************** "BLOCKS FREE"DIRL8 LDY #0 TXA PHA JSR PUTNAM INY INY LDA #3 STA TEMPDIRL9 INX ;SKIP SPACES UNTIL "PRG" LDA DIRIN+4,X CMP #32 ;' ' BEQ DIRL9 CMP #'* BNE DIRL10 STA DIRBUF-1,YDIRL14 INXDIRL10 LDA DIRIN+4,X ;PUT "SEQ" OR "PRG" IN BUFFE	Y; 3 CLEARS ALL SELECTIONS; 5 SELECTS ALL FILES DOWN; 7 GOES TO BOTTOM OF SCRREN THEN DIRECTORY;;--------------------------------------;; NAME FOR  FUNCTIONS .DEF SCROLLD ;IRECTORY; ALL THIS SYMBOLS SHOULD BE DECLEARED; AS EXTERNAL CHAR.
 LDA #$60 ;ALLOW FOR TRAILING SPACESDIRL12 STA DIRBUF-1,X ;CLEAR CURRENT LINE DEX BNE DIRL12 LDA ENDDIR BEQ DIRL13 CMP #$80 BEQ DIRL11 ;FINISHED DIRECTORY PHA AND #$80 STA ENDDIR PLA AND #$7F CMP #2 BNE DIRL15 JMP DIRL16 ;DO BLOCKS FREEU2 LDA NUMBER,X ;PUT NUMBER INTO BUFFER BEQ PUTNU3 STA DIRBUF,Y INX INY BNE PUTNU2PUTNU3 RTS ;WILL RETURN CARRY CLEAR;PUTNAM TYA ;PUT NAME INTO BUFFER CLC ADC #16 PHAPUTNA2 INX LDA DIRIN+3,X CMP #$22 ;LOOK FOR QUOTE BNE PUTNA2PUTNA3 M+1 SBC #0 BCS DIR2A LDA NUMTOP ;NO, AT LEAST ONE SAVED? BNE DIR2CDIR2F JSR DSCRLU ;NO, JUST SCROLL UP, DON'T SAVE JMP DIR2BDIR2C;SCROLL SAVED LINES UP BY 1 LDA DRST STA GEN SEC SBC #DIRWID STA PNT LDA DRST+1 STA GEN+1 SBC #0 STA PNT+17 LDA #$11 ;DO A CURSOR DOWN JMP DIR26;DIR47 JSR SETSCN LDY #18 LDA (SCREN),Y;CMP #18 ; REL FILE;CLC;BEQ DIR48 CMP #04 CLC BEQ DIR48 LDY #13DIR28 DEY CLC BMI DIR48 LDA (SCREN),Y CMP BLKDAT,Y BEQ DIR28 LDY #5DIR30 DEY CLC BMI DIRTTERN STRING STY PATTERNBF+2 ; LDX C$PARMS+2 LDY C$PARMS+3 STX CROUT+1   ; ADDRESS OF  ROUTINE STY CROUT+2   ; LDX STACKPTR LDY STACKPTR+1 STX SVSTACKP STY SVSTACKP+1MULSEN LDA #$60 STA $EA0B ;CHANGE CLEAR LDA #147  ;CLEAR SCREEN JSR SCRUP AND SAVE TOP LINE STA FREMEM+1DIR2D JSR DIRDWN ;YESDIR2B DEC VTABDIR2 JSR PRDRBF ;PRINT THE LINE INC VTAB LDA STKEY CMP #$DF BEQ DIR68 JSR GETKEY ;COMMODORE OR RUN/STOP HELD DOWN? BEQ TODIR1 CMP #3 BEQ DIR3D ;YES, STOP DIRECTORY LDA VT JMP DIR6DIR8 CMP #$11 BNE DIR11DIR15 CPY #MAXLNE-1 BEQ DIR9 INC VTAB BNE DIR67DIR9 LDA NUMBOT ;ANY TEXT OFF BOTTO BEQ DIR67 ;NO DEC NUMBOT JSR MVDRBF ;MOVE NEXT LINE OFF BOTTOM TO BUFFER JSR DIRDWN ;SAVE TOP LINE, SCROLL UP AND ADVANCE TXTAM+3,X LDA #0 STA DIRNAM+4,X TXA CLC ADC #5DIR66 STA DIRLEN LDA #0 STA ENDDIR STA NUMTOP STA NUMBOT LDA #TOPLIN STA VTAB LDY #<EMPTY LDA #>EMPTY STY FREMEM STA FREMEM+1 LDX #>MEMORY ;POINT TO FIRST FREE BYTE STX TXTPNT+1 LDA #<MEMORYMODORE OR RUN/STOP, CLOSE DIRECTORY JSR CLOSE JMP DIR3ADIR3 JSR CHKERR ;CLEAR ANY ERROR IF IT GOT ONE BCC DIR69DIR69 LDA #DIRCHN JSR CLOSE JMP DIR3BDIR3C ;JSR HEADER ;PRINT DISK ERROR JMP DIR3ADIR3B LDA DIRNAM+1 ; CMP #'0  ;****** SHOULD B BEQ DIR59 CMP #133 ;TOP OF DIRECTORY F1 BNE DIR19DIR59 CPY #TOPLIN ;IN TOP CORNER? BNE DIR13A ;NO LDA HTAB BNE DIR13A ;NO JSR DIR46 JMP DIR21DIR13A STX HTAB ;0 LDA #TOPLIN STA VTAB BNE TODIR6DIR19 CMP #136 ;BOTTOM OF DIRECTORY  F7 BNE DISTY C$PARMS+3 LDA #4 JSR PRINTF JSR RESETSTACK JMP PRESSDIR1 JSR DIRLNE ;GET NEXT DIRECTORY LINE BCC DIR1E JMP DIR3 ;END OF DIRECTORYDIR1E LDA VTAB CMP #MAXLNE ;NEED TO SCROLL? BNE DIR2 LDA FREMEM ;ENOUGH MEMORY? SBC #DIRWID TAX LDA FREMEQ DIR6 DEC VTABDIR6 JSR INPUT BCC DIR26 JMP DIR60DIR26 LDX #0 LDY VTAB BIT DIRFLAG BMI DIR23 CMP #$20 BEQ DIRZZ CMP #$0D BNE DIR23DIRZZ JSR DIR47 BCC DIR27 LDY #DIRWID-1DIR25 LDA (SCREN),Y EOR #$80 STA (SCREN),Y DEY BPL DIR25DIR2LDA DIRIN+4,X CMP #$22 BEQ PUTNA4 JSR TOSCN ;CONVERT TO SCREN CODE STA DIRBUF,Y ;SAVE NAME INY INX BNE PUTNA3PUTNA4 PLA ;SET Y TO 16 CHARACTERS PAST WHERE IT USED TO BE TAYDIRD7 RTS;SCROLLD LDX C$PARMS LDY C$PARMS+1 STX PATTERNBF+1 ; PA LDY #0 SEI LDA #$34 STA $01MOVDIR LDA (GEN),Y STA (PNT),Y LDA GEN CMP TXTPNT LDA GEN+1 SBC TXTPNT+1 JSR INCGEN JSR INCPNT BCC MOVDIR LDA #$37 STA $01 CLI JSR SUBTXT DEC NUMTOP ;ONE LESS ON TOP JMP DIR2DDIR2A STX FREMEM ;YES, SCROLL 48 LDA (SCREN),Y CMP DRVDAT,Y BEQ DIR30 LDY #DIRWIDDIR24 DEY CLC BMI DIR48 LDA (SCREN),Y CMP #$60 BEQ DIR24 SECDIR48 RTS;DIR23 CMP #$91 BNE DIR8 CPY #TOPLIN BNE DIR7 LDA NUMTOP BEQ DIR6 ;AT TOP JSR DIRUP ;SCROLL DIRECTORY UPDIR67OUT LDA #$20 ;CHANGE BACK STA $EA0B LDA #TOPLIN STA TOPSCN LDA #MAXLNE-1 STA BOTSCNDIRD2 ;LDA #'0  ;BOTH DRIVES WITH A PATTERN ;STA DIRNAM+1 LDX #0PATTERNBF LDA !0000,X BEQ ENDPAT INX STA DIRNAM+2,X BNE PATTERNBFENDPAT LDA #'* STA DIRNAB CMP #MAXLNE ;DISPLAY TO END OF SCREN BEFORE WAITING BNE TODIR1DON1 LDA STKEY CMP #$DF BEQ DIR68 JSR GETKEY ;WAIT FOR CHARACTER BEQ DON1TODIR1 JMP DIR1DIR68 LDA #DIRCHN ;CLOSE DIRECTORY AND EXIT JSR CLOSE JMP DIR60DIR3D LDA #DIRCHN ;COMPNT JSR PRDRBF ;PRINT NEW BOTTOM LINE JMP DIR6DIR11 CMP #$1D ;CURSOR FORWARD BNE DIR12 LDA HTAB CMP #WIDTH-1 BEQ TODIR6 INC HTABTODIR6 JMP DIR6DIR12 CMP #$9D ;CURSOR BACK BNE DIR13 LDA HTAB BEQ TODIR6 DEC HTAB JMP DIR6DIR13 CMP #$13 	 STA TXTPNT CLC ADC #DIRWID STA DRST TXA ADC #0 STA DRST+1OPNDR JSR OPNDIR BCC DIR1 ;DISK ERROR LDA #DIRCHN ;YES, CLOSE FILE JSR CLOSE JSR SAVEZERO LDX #<MSG1 LDY #>MSG1 STX C$PARMS STY C$PARMS+1 LDX #<TFNAM LDY #>TFNAM STX C$PARMS+2 
E A 1 IF DUAL DRIVE LDA #0 BEQ DIR3A ;DONE BOTH DRIVESDONXT INC DIRNAM+1 ;DO NEXT DRIVE LDA #0 STA ENDDIR JMP OPNDRDIR3A LDX #0 STX HTAB JSR DIR46 ;SCROLL TO TOP OF DIRECTORYDIR7 LDA VTAB ;IF ON TOP LINE DON'T MOVE UP 1 LINE CMP #TOPLIN BER22 LDA #MAXLNE-1 CMP VTAB STA VTAB BEQ DIR20DIR21 JMP DIR6DIR20 LDA NUMBOT ;ANY DIR LINES OFF BOTTOM BEQ DIR21 DEC NUMBOT JSR MVDRBF JSR DIRDWN JSR PRDRBF JMP DIR20DIR22 CMP #3 ;RUN/STOP TO EXIT BNE DIR42DIR17 JMP DIR33DIR42 BIT DIRIR LINES OFF BOTTOM BEQ DIR32 DEC NUMBOT JSR MVDRBF JSR DIRDWN JSR PRDRBF JMP DIR31DIR32 LDX #TOPLINDIR39 STX VTAB JSR DRSVLN INC NUMTOP LDX VTAB CPX #MAXLNE-1 BCS DIR34 INX JSR ADTXT JMP DIR39;DIR34 LDA #<MEMORY PHA STA TXTPNT LDTA $01 LDX TFNAM INX INX STX TFNAM ;SEND ,? ALSO JSR DISTRN ; <- ROUTINE FOR EVERY FILE LDA NUMFIL BNE DIR64 DEC NUMFIL+1DIR64 DEC NUMFIL PLA STA TXTPNT+1 PLA STA TXTPNTDIR36 JSR ADTXT DEC NUMBOT LDA CAN ;WAS THERE AN ERROR? BNE DIR60TAB CMP #MAXLNE-1 BCS DIR51 INC VTAB BCC DIR50DIR51 LDA NUMBOT BEQ DIR58 DEC NUMBOT JSR MVDRBF JSR DIRDWN JSR PRDRBF JMP DIR50DIR58 JSR DIR46DIR61 JMP DIR6;DIR43 CMP #135 ;SET ALL ENTRIES FROM CURSOR F5 BNE DIR52DIR54 JSR DIR47 BCC CLI PLA STA NUMBOT PLA STA TXTPNT+1 PLA STA TXTPNT SEC LDA NUMFIL SBC #1 STA NUMFIL LDA NUMFIL+1 SBC #0 STA NUMFIL+1 BCS DIR65 LDX #<MSG2 LDY #>MSG2 STX C$PARMS STY C$PARMS+1 JSR SAVEZERO LDA #2 JSR PRINTF JSR RESETSTACKREGET JSRDRBF ;PRINT LINE FROM BUFFER;INCPNT INC PNT BNE SUBTX2 INC PNT+1 RTS;INCGEN INC GEN BNE SUBTX2 INC GEN+1 RTS;SUBTXT LDA TXTPNT SEC SBC #DIRWID STA TXTPNT BCS SUBTX2 DEC TXTPNT+1SUBTX2 RTS;MVDRBF LDY #DIRWID-1 ;MOVE LINE TO BUFFEBNE DIR55 JMP DIR50DIR55 JMP DIR6;DIR46 LDA #TOPLIN ;TOP OF DIRECTORY STA VTABDIR44 LDA NUMTOP BEQ DIR45 JSR DIRUP JMP DIR44DIR45 RTS;OPNDIR LDX #<DIRNAM ;OPEN DIRECTORY FILE LDY #>DIRNAM LDA DIRLEN JSR SETNAM LDA #DIRCHN LDY #0 LDTXTPNT),Y BPL DIR65 LDY #16DIR35 DEY ;FIND FIRST NON-SPACE BMI DIR65 LDA (TXTPNT),Y CMP #$E0 BEQ DIR35 TYA TAX INY INY; 0 & : INY STY TFNAM ;SAVE LENGTH OF FILE NAME LDY #18 ;GET FILE TYPE LDA (TXTPNT),Y AND #$3F ;CONVERT TO LOWER CASE O RD1 LDA #$37 STA $01 CLI RTS;DSCRLU LDX TOPSCNDSCRL2 JSR SETSCX CLC LDA SCREN ADC #WIDTH STA PNT LDA SCREN+1 ADC #0 STA PNT+1 LDY #WIDTH-1DSCRL1 LDA (PNT),Y STA (SCREN),Y DEY BPL DSCRL1 INX CPX BOTSCN BCC DSCRL2DSCRL6 LDA #32 ;TPNT+1DIRDW2 RTS;PRDRBF LDA HTAB ;PRINT DIRECTORY BUFFER PHA LDX #0 STX HTABPRDRB2  LDA DIRBUF,X JSR SOUT INX CPX #DIRWID BNE PRDRB2 PLA STA HTABDIR41 RTS;DIR33 BIT DIRFLAG BMI DIR41 LDA #MAXLNE-1 STA VTABDIR31 LDA NUMBOT ;ANY D AND FILE TYPE IN BUFFER STA TFNAM+3,Y ; , PLA STA TFNAM+4,Y ; ? LDA #0 STA CAN; LDA #$93; JSR SCROUT LDA TXTPNT ;SAVE POINTER JUST IN CASE ALLAN'S GARBAGE KILLS IT PHA LDA TXTPNT+1 PHA LDA #$37 STA $01 LDX NUMFIL LDA NUMFIL+1 LDA #$37 SFLAG ;NOT ALLOWED TO HIGHLIGHT ENTRIES IF IN DIRECTORY MODE BMI DIR61 CMP #134 ;CLEAR ALL DIRECTORY ENTRIES F3 BNE DIR43 JSR DIR46 ;TOP OF DIRECTORYDIR50 JSR SETSCN LDY #DIRWID-1DIR49 LDA (SCREN),Y AND #$7F STA (SCREN),Y DEY BPL DIR49 LDA VA #>MEMORY PHA STA TXTPNT+1 LDA NUMTOP PHA STA NUMBOT LDA #0 STA NUMFIL STA NUMFIL+1 SEI LDA #$34 STA $01 LDY #18DIR63 LDA (TXTPNT),Y BPL DIR62 INC NUMFIL BNE DIR62 INC NUMFIL+1DIR62 JSR ADTXT DEC NUMBOT BNE DIR63 LDA #$37 STA $01 JSR CLRCHN JMP GETENT ;NODIR60 CLI;+++++; LDA #$04; LDX #$00; LDY #$00; JMP C$106;----- RTS;DIRUP JSR SUBTXT ;MOVE NEXT TOP LINE INTO BUFFER JSR MVDRBF LDX #MAXLNE-1 JSR DRSVLN ;SAVE BOTTOM LINE DEC NUMTOP INC NUMBOT JSR DSCRLD JMP P DIR56 LDY #DIRWID-1DIR53 LDA (SCREN),Y EOR #$80 STA (SCREN),Y DEY BPL DIR53DIR56 LDA VTAB CMP #MAXLNE-1 BCS DIR57 INC VTAB BCC DIR54DIR57 LDA NUMBOT BEQ DIR55 DEC NUMBOT JSR MVDRBF JSR DIRDWN JSR PRDRBF JMP DIR54;DIR52 CMP #138 R GETIN BNE CHECKAB LDA STKEY CMP #$DF BNE REGET RTSCHECKAB CMP #13 BNE REGET JMP MULSEN ; BACK;DIR65 PHA LDA #$37 STA $01 PLA JMP DIR36GETENT LDA NUMBOT BNE DIR38 JMP DIR60 ;NO MORE FILESDIR38 SEI LDA #$34 STA $01 LDY #18 LDA (R SEI LDA #$34 STA $01MVDRB2 LDA (TXTPNT),Y STA DIRBUF,Y DEY BPL MVDRB2 LDA #$37 STA $01 CLI RTS;DRSVLN JSR SETSCX ;SAVE LINE SEI LDA #$34 STA $01 LDY #DIRWID-1DIRD1 LDA (SCREN),Y ;MOVE TOP LINE TO BUFFER STA (TXTPNT),Y DEY BPL DI	X DEVNUM JSR SETLFS JSR OPEN ;SA=0, OPEN AND CHECK IF ERROR JMP CHKERR;DIRDWN LDX #TOPLIN JSR DRSVLN ;SAVE THE TOP LINE INC NUMTOP JSR DSCRLUADTXT LDA TXTPNT ;MOVE TEXT POINTER TO NEXT POSITION CLC ADC #DIRWID STA TXTPNT BCC DIRDW2 INC TX
FF REVERSE AND PET ASCII JSR TOPET PHA LDA INDRIVE STA TFNAM+1 LDA #': STA TFNAM+2 LDY #0 ;MOVE NAME AND CONVERT TO PET CODEDIR37 LDA (TXTPNT),Y EOR #$80 JSR TOPET STA TFNAM+3,Y INY DEX BPL DIR37 LDA #$37 STA $01 CLI LDA #',   ;PUT ","' ' LDY #WIDTH-1DSCRL3 STA (PNT),Y DEY BPL DSCRL3 RTS;DSCRLD LDX #MAXLNE-1DSCRL5 JSR SETSCX LDA SCREN SEC SBC #WIDTH STA PNT LDA SCREN+1 SBC #0 STA PNT+1 LDY #WIDTH-1DSCRL4 LDA (PNT),Y STA (SCREN),Y DEY BPL DSCRL4 DEX CPX #TOPLIEC5 DEX BPL DEC6 PLA ;FIX STACK RTS;TOPET STX SAVEBY+1 PHA LSR A LSR A LSR A LSR A LSR A TAX PLA AND #%00011111 ORA CNBTBL,X LDX SAVEBY+1 RTSTOSCN STX SAVEBY+1 PHA AND #%11100000 LDX #6TOSCN1 CMP CNBTBL,X BEQ TOSCN2 DEX BPL TSV .BYTE 0TEMP   .BYTE 0LINTBL .BYTE <0,<40,<80,<120,<160,<200,<240,<280,<320,<360,<400,<440,<480       .BYTE <520,<560,<600,<640,<680,<720,<760,<800,<840,<880,<920,<960,<1000LINTBH .BYTE >0,>40,>80,>120,>160,>200,>240,>280,>320,>360,>400,>440,>480 TA (SCREN),Y LDY SCNYSV PLA ;CS IF COMMODORE KEY RTS;;SETSCN LDX VTAB ;GET SCREN LINESETSCX LDA LINTBL,X ;SET UP SCREN LINE POINTER STA SCREN STA COLR LDA LINTBH,X ORA #>SCN STA SCREN+1 AND #$03 ORA #>COL STA COLR+1 RTS;SOUT PHA PHASR PRINTF JSR RESETSTACKKEYW JSR GETIN BEQ KEYWRTS;;; CHECK ERROR CHANNEL;;USES - AC XR YR;RETURNS SEC=ERROR CLC=NO ERROR;CHKERR LDA CURDEV ;CURRENT DEVICE JSR TALK LDA #%01101111 ;SEC ADDR 15 JSR TALKSA LDA #0 TAY STA STATUS ;CLEAR S  .BYTE 0SVSTACKP .BYTE 0, 0MSG1   .BYTE 147,"   ",196,"ISK ERROR",13, "   %S",13       .BYTE 0MSG2   .BYTE 147,"   ",206,"O FILES SELECTED",13       .BYTE "   ",208,"RESS CBM KEY TO ABORT",13       .BYTE "   ",208,"RESS RETURN TO RE READ DIRECTORYMORY STX DECML2 ;LOW TAX ;CMP #0 BNE DEC7 LDX #2 ;SAVE TIME IF <256 .BYTE $2CDEC7 LDX #4 ;NUMBER OF DIGITS LEFT TO PRINT (-1) TYA ;MINUS = OUTPUT TO MEMORY PHA LDA #0 STA DECML1 ;NO LEADING SPACES TAY ;NUMBER OF DIGITS PRINTEDDEC6 LDA #'0    ;START IS AT $22 STA ZEROSAVE-1,X DEX BNE RES2 RTSRESETSTACK LDX SVSTACKP LDY SVSTACKP+1 STX STACKPTR STY STACKPTR+1; RTSRESTZERO LDX #8RES1 LDA ZEROSAVE-1,X STA $21,X         ;START IS AT $22 DEX BNE RES1 RTSTFNAM  .BSS 30 ; *KQ DEC4 ;MAYBE DEC DECML1 ;NO, SET MINUSDEC4 BIT DECML1 BPL DEC5 ;IF LEADING ZERO, WILL TAKE THISDEC3 INY PLA PHA BPL DEC8 LDA DECML3 STA NUMBER-1,Y ;OUTPUT TO MEMORY LDA #0 STA NUMBER,Y BEQ DEC5DEC8 LDA DECML3 JSR SOUT ;OUTPUT TO SCRENDDAT .BYTE "DRIVE",96BLKDAT .BYTE "BLOCKS",96,"FREE",96,"=",96DIRNAM .BYTE "$0:1234567890123456"DRST   .BYTE 0,0FREMEM .BYTE 0,0DIRFLAG .BYTE 0NUMBER .BYTE 0,0,0,0,0,0DIRLEN .BYTE 0START  .BYTE 0,0HTAB   .BYTE 0VTAB   .BYTE 0SCNYSV .BYTE 0SCNXN BNE DSCRL5 BEQ DSCRL6;INPUT STY SCNYSV JSR SETSCN LDY HTAB LDA (SCREN),Y EOR #$80 STA (SCREN),Y LDA FRGCOLOR STA (COLR),YINPUT1 LDA STKEY CMP #$DF BEQ INPUT2 JSR GETKEY BEQ INPUT1 CLCINPUT2 PHA LDY HTAB LDA (SCREN),Y EOR #$80 SOSCN1TOSCN2 PLA AND #%00011111 STA SAVEBY TXA ASL A ASL A ASL A ASL A ASL A ORA SAVEBY LDX SAVEBY+1 RTS;PRESS JSR CLRCHN LDA #00 STA 198 ;CLEAR KEYBOARD BUFFER LDX #<MSG3 LDY #>MSG3 STX C$PARMS STY C$PARMS+1 JSR SAVEZERO LDA #2 J      .BYTE >520,>560,>600,>640,>680,>720,>760,>800,>840,>880,>920,>960,>1000;TOPSCN .BYTE 0BOTSCN .BYTE 0DECML1 .BYTE 0DECML2 .BYTE 0,0DECML3 .BYTE 0NUMFIL .BYTE 0,0 ;NUMBER OF FILES TO SENDDEVNUM .BYTE 8INDRIVE .BYTE "0"FRGCOLOR .BYTE 0CAN   STX SCNXSV STY SCNYSV JSR SETSCN LDY HTAB PLA STA (SCREN),Y LDA FRGCOLOR STA (COLR),Y INC HTAB PLA LDX SCNXSV LDY SCNYSV RTS;DCOUT2 LDA #0 ;OUTPUT 1 BYTE NUMBER (IN X) TAYDECOUT STA DECML2+1 ;HIGH; OUTPUT DECIMAL NUMBER TO SCREN OR METATUS JSR GETBYT STA TFNAM+1,Y TAX ; BYT1 JSR GETBYT INY STA TFNAM+1,Y;CE100 INY JSR GETBYT STA TFNAM+1,Y LDA STATUS BEQ CE100; INY STY TFNAM; JSR UNTALK CPX #'1 BCS CE110 CPY #'1;CE110 RTSSAVEZERO LDX #8RES2 LDA $21,X       l",13       .BYTE 0MSG3   .BYTE 13,"   ",208,"RESS A KEY TO CONTINUE.", 13       .BYTE 0ZEROSAVE .BSS 8 0DECML1 .BYTE 0DECML2 .BYTE 0,0DECML3 .BYTE 0NUMFIL .BYTE 0,0 ;NUMBER OF FILES TO SENDDEVNUM .BYTE 8INDRIVE .BYTE "0"FRGCOLOR .BYTE 0CAN  	STA DECML3 ;DIGITDEC1 LDA DECML2 CMP LOW,X LDA DECML2+1 SBC HIGH,X BCC DEC2 STA DECML2+1 LDA DECML2 SBC LOW,X STA DECML2 INC DECML3 BNE DEC1DEC2 LDA DECML3 ;GET DIGIT INX DEX BEQ DEC3 ;ALWAYS PRINT LAST DIGIT CMP #'0  ;LEADING ZERO? BE
=*+30CNBTBL .BYTE $40,$20,$C0,$A0,$00,$60,$80,$E0SAVEBY .BYTE $FF,$00;LOW    .BYTE <1,<10,<100,<1000,<10000HIGH   .BYTE >1,>10,>100,>1000,>10000NUMTOP .BYTE 0NUMBOT .BYTE 0DIRBUF .BSS DIRWID  ;*=*+DIRWIDENDDIR .BYTE 0DIRIN  .BSS 32  ;*=*+32DRVKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKK